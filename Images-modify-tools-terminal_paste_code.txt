bash <(cat <<'EOS'
#!/usr/bin/env bash
# ==============================================
# Dolphin ServiceMenu: Images Modify Tools
# ObsÅ‚uga plikÃ³w obrazÃ³w (PNG/JPG):
#   - Optimize (optymalizacja wag)
#   - Convert (wybÃ³r formatu docelowego)
# Dependencies: optipng, jpegoptim, imagemagick, kdialog
# ==============================================

BASE="$HOME/.local/share"
SERVICES="$BASE/kio/servicemenus"
SCRIPTS="$BASE/dolphin-scripts"

# === BLOK LOKALIZACJI ===
lang=${LANG:0:2}

say() {
  case $lang in
    pl) echo "$1" ;; de) echo "$2" ;; fr) echo "$3" ;; es) echo "$4" ;;
    it) echo "$5" ;; ru) echo "$6" ;; zh) echo "$7" ;; *) echo "$1" ;;
  esac
}
ask_msg() {
  case $lang in
    pl) kdialog --msgbox "$1" ;; de) kdialog --msgbox "$2" ;; fr) kdialog --msgbox "$3" ;;
    es) kdialog --msgbox "$4" ;; it) kdialog --msgbox "$5" ;; ru) kdialog --msgbox "$6" ;;
    zh) kdialog --msgbox "$7" ;; *) kdialog --msgbox "$1" ;;
  esac
}
ask_error() {
  case $lang in
    pl) kdialog --error "$1" ;; de) kdialog --error "$2" ;; fr) kdialog --error "$3" ;;
    es) kdialog --error "$4" ;; it) kdialog --error "$5" ;; ru) kdialog --error "$6" ;;
    zh) kdialog --error "$7" ;; *) kdialog --error "$1" ;;
  esac
}

install_all() {
  mkdir -p "$SERVICES" "$SCRIPTS"

  cat > "$SERVICES/Images-Modify-Tools.desktop" <<EOF
[Desktop Entry]
Type=Service
ServiceTypes=KonqPopupMenu/Plugin
MimeType=image/*;
X-KDE-Submenu=Modify selected file
X-KDE-Submenu[pl]=Modyfikuj zaznaczony plik
X-KDE-Submenu[de]=Datei bearbeiten
X-KDE-Submenu[fr]=Modifier le fichier
X-KDE-Submenu[es]=Modificar archivo
X-KDE-Submenu[it]=Modifica file
X-KDE-Submenu[ru]=Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ»
X-KDE-Submenu[zh_CN]=ä¿®æ”¹æ–‡ä»¶
Actions=OptimizeImage;ConvertImage
Icon=insert-image

[Desktop Action OptimizeImage]
Name=Optimize image
Name[pl]=Optymalizuj obraz
Name[de]=Bild optimieren
Name[fr]=Optimiser image
Name[es]=Optimizar imagen
Name[it]=Ottimizza immagine
Name[ru]=ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ
Name[zh_CN]=ä¼˜åŒ–å›¾åƒ
Exec=$SCRIPTS/image-optimize.sh %F
Icon=document-save

[Desktop Action ConvertImage]
Name=Convert image
Name[pl]=Konwertuj obraz
Name[de]=Bild konvertieren
Name[fr]=Convertir image
Name[es]=Convertir imagen
Name[it]=Converti immagine
Name[ru]=ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ
Name[zh_CN]=è½¬æ¢å›¾åƒ
Exec=$SCRIPTS/image-convert.sh %F
Icon=applications-graphics
EOF

  # --- Optimize image ---
  cat > "$SCRIPTS/image-optimize.sh" <<'EOF2'
#!/usr/bin/env bash
lang=${LANG:0:2}

if ! command -v optipng &>/dev/null && ! command -v jpegoptim &>/dev/null; then
  case $lang in
    pl) kdialog --error "âŒ Brak optipng/jpegoptim (zainstaluj: sudo apt install optipng jpegoptim)" ;;
    de) kdialog --error "âŒ optipng/jpegoptim fehlt (installiere: sudo apt install optipng jpegoptim)" ;;
    fr) kdialog --error "âŒ optipng/jpegoptim est manquant (installez: sudo apt install optipng jpegoptim)" ;;
    es) kdialog --error "âŒ Falta optipng/jpegoptim (instalar: sudo apt install optipng jpegoptim)" ;;
    it) kdialog --error "âŒ optipng/jpegoptim mancanti (installa: sudo apt install optipng jpegoptim)" ;;
    ru) kdialog --error "âŒ optipng/jpegoptim Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ (ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ: sudo apt install optipng jpegoptim)" ;;
    zh) kdialog --error "âŒ ç¼ºå°‘ optipng/jpegoptim (å®‰è£…: sudo apt install optipng jpegoptim)" ;;
  esac
  exit 1
fi

for f in "$@"; do
  ext="${f##*.}"
  if [[ "$ext" =~ png|PNG ]]; then
    optipng -o7 "$f"
  elif [[ "$ext" =~ jpg|jpeg|JPG|JPEG ]]; then
    jpegoptim --max=85 "$f"
  fi
done

case $lang in
  pl) kdialog --msgbox "âœ… Optymalizacja zakoÅ„czona" ;;
  de) kdialog --msgbox "âœ… Optimierung abgeschlossen" ;;
  fr) kdialog --msgbox "âœ… Optimisation terminÃ©e" ;;
  es) kdialog --msgbox "âœ… OptimizaciÃ³n completa" ;;
  it) kdialog --msgbox "âœ… Ottimizzazione completata" ;;
  ru) kdialog --msgbox "âœ… ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°" ;;
  zh) kdialog --msgbox "âœ… ä¼˜åŒ–å®Œæˆ" ;;
esac
EOF2

  # --- Convert image ---
  cat > "$SCRIPTS/image-convert.sh" <<'EOF2'
#!/usr/bin/env bash
lang=${LANG:0:2}

if ! command -v magick &>/dev/null && ! command -v convert &>/dev/null; then
  case $lang in
    pl) kdialog --error "âŒ Brak ImageMagick (sudo apt install imagemagick)" ;;
    de) kdialog --error "âŒ ImageMagick fehlt (sudo apt install imagemagick)" ;;
    fr) kdialog --error "âŒ ImageMagick est manquant (sudo apt install imagemagick)" ;;
    es) kdialog --error "âŒ Falta ImageMagick (sudo apt install imagemagick)" ;;
    it) kdialog --error "âŒ ImageMagick mancante (sudo apt install imagemagick)" ;;
    ru) kdialog --error "âŒ ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ ImageMagick (sudo apt install imagemagick)" ;;
    zh) kdialog --error "âŒ ç¼ºå°‘ ImageMagick (å®‰è£…: sudo apt install imagemagick)" ;;
  esac
  exit 1
fi

fmt=$(kdialog --menu "Wybierz format docelowy:" \
  jpg "JPEG" \
  png "PNG" \
  webp "WebP" \
  tiff "TIFF" \
  bmp "BMP" \
  gif "GIF") || exit 0

for f in "$@"; do
  b="${f%.*}"
  if command -v magick &>/dev/null; then
    magick "$f" "$b.$fmt"
  else
    convert "$f" "$b.$fmt"
  fi
done

case $lang in
  pl) kdialog --msgbox "âœ… Pliki skonwertowane do: $fmt" ;;
  de) kdialog --msgbox "âœ… Dateien konvertiert nach: $fmt" ;;
  fr) kdialog --msgbox "âœ… Fichiers convertis en : $fmt" ;;
  es) kdialog --msgbox "âœ… Archivos convertidos a: $fmt" ;;
  it) kdialog --msgbox "âœ… File convertiti in: $fmt" ;;
  ru) kdialog --msgbox "âœ… Ğ¤Ğ°Ğ¹Ğ»Ñ‹ ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ²: $fmt" ;;
  zh) kdialog --msgbox "âœ… æ–‡ä»¶å·²è½¬æ¢ä¸º: $fmt" ;;
esac
EOF2

  chmod +x "$SERVICES/Images-Modify-Tools.desktop" "$SCRIPTS"/image-*.sh
  say "âœ… Zainstalowano narzÄ™dzia do obrazÃ³w (Optimize & Convert)" \
      "âœ… Bild-Tools installiert (Optimieren & Konvertieren)" \
      "âœ… Outils Image installÃ©s (Optimiser & Convertir)" \
      "âœ… Herramientas Imagen instaladas (Optimizar & Convertir)" \
      "âœ… Strumenti Immagine installati (Ottimizza & Converti)" \
      "âœ… Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹ (ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¸ ĞšĞ¾Ğ½Ğ²ĞµÑ€ÑĞ¸Ñ)" \
      "âœ… å·²å®‰è£…å›¾åƒå·¥å…· (ä¼˜åŒ–ä¸è½¬æ¢)"
}

uninstall_all() {
  rm -f "$SERVICES/Images-Modify-Tools.desktop" "$SCRIPTS"/image-*.sh
  say "ğŸ—‘ UsuniÄ™to narzÄ™dzia obrazÃ³w (Optimize & Convert)" \
      "ğŸ—‘ Bild-Tools entfernt (Optimieren & Konvertieren)" \
      "ğŸ—‘ Outils Image supprimÃ©s (Optimiser & Convertir)" \
      "ğŸ—‘ Herramientas Imagen eliminadas (Optimizar & Convertir)" \
      "ğŸ—‘ Strumenti Immagine rimossi (Ottimizza & Converti)" \
      "ğŸ—‘ Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ñ‹ (ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¸ ĞšĞ¾Ğ½Ğ²ĞµÑ€ÑĞ¸Ñ)" \
      "ğŸ—‘ å·²åˆ é™¤å›¾åƒå·¥å…· (ä¼˜åŒ–ä¸è½¬æ¢)"
}

# ==== MENU ====
say "ğŸ¬ Image Tools Installer  1 Instaluj, 2 Odinstaluj, 3 WyjÅ›cie" \
    "ğŸ¬ Bild-Tools Installer  1 Installieren, 2 Deinstallieren, 3 Beenden" \
    "ğŸ¬ Installateur Outils Image  1 Installer, 2 Supprimer, 3 Quitter" \
    "ğŸ¬ Instalador Herramientas Imagen  1 Instalar, 2 Desinstalar, 3 Salir" \
    "ğŸ¬ Installer Strumenti Immagine  1 Installa, 2 Rimuovi, 3 Esci" \
    "ğŸ¬ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ñ‰Ğ¸Ğº Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ˜Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹  1 Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ, 2 Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ, 3 Ğ’Ñ‹Ñ…Ğ¾Ğ´" \
    "ğŸ¬ å›¾åƒå·¥å…·å®‰è£…ç¨‹åº  1 å®‰è£…, 2 å¸è½½, 3 é€€å‡º"

read -rp "ğŸ‘‰ " choice

case "$choice" in
  1) install_all ;;
  2) uninstall_all ;;
  3) exit 0 ;;
  *) say "âŒ NieprawidÅ‚owy wybÃ³r" \
         "âŒ UngÃ¼ltige Wahl" \
         "âŒ Choix invalide" \
         "âŒ OpciÃ³n invÃ¡lida" \
         "âŒ Scelta non valida" \
         "âŒ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ±Ğ¾Ñ€" \
         "âŒ æ— æ•ˆçš„é€‰æ‹©"; exit 1 ;;
esac
EOS
)
