bash <(cat <<'EOS'
#!/usr/bin/env bash
# ==============================================
# Dolphin ServiceMenu: Download video/audio via yt-dlp
# Dependencies: yt-dlp, kdialog, xclip/xsel
# ==============================================

BASE="$HOME/.local/share"
SERVICES="$BASE/kio/servicemenus"
SCRIPTS="$BASE/dolphin-scripts"

# === BLOK LOKALIZACJI ===
lang=${LANG:0:2}

say() {
  case $lang in
    pl) echo "$1" ;; de) echo "$2" ;; fr) echo "$3" ;; es) echo "$4" ;;
    it) echo "$5" ;; ru) echo "$6" ;; zh) echo "$7" ;; *) echo "$1" ;;
  esac
}

ask_msg() {
  case $lang in
    pl) kdialog --msgbox "$1" ;; de) kdialog --msgbox "$2" ;; fr) kdialog --msgbox "$3" ;;
    es) kdialog --msgbox "$4" ;; it) kdialog --msgbox "$5" ;; ru) kdialog --msgbox "$6" ;;
    zh) kdialog --msgbox "$7" ;; *) kdialog --msgbox "$1" ;;
  esac
}

ask_error() {
  case $lang in
    pl) kdialog --error "$1" ;; de) kdialog --error "$2" ;; fr) kdialog --error "$3" ;;
    es) kdialog --error "$4" ;; it) kdialog --error "$5" ;; ru) kdialog --error "$6" ;;
    zh) kdialog --error "$7" ;; *) kdialog --error "$1" ;;
  esac
}

install_all() {
  mkdir -p "$SERVICES" "$SCRIPTS"

  # === Desktop Entry (.desktop) ===
  cat > "$SERVICES/Download-Video.desktop" <<EOF
[Desktop Entry]
Type=Service
ServiceTypes=KonqPopupMenu/Plugin
MimeType=inode/directory;
Actions=PasteVideoURL
Icon=download

[Desktop Action PasteVideoURL]
Name=Download video (paste URL)
Name[pl]=Pobierz film (wklej URL)
Name[de]=Video herunterladen (URL einfÃ¼gen)
Name[fr]=TÃ©lÃ©charger la vidÃ©o (coller URL)
Name[es]=Descargar vÃ­deo (pegar URL)
Name[it]=Scarica video (incolla URL)
Name[ru]=Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð²Ð¸Ð´ÐµÐ¾ (Ð²ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ URL)
Name[zh_CN]=ä¸‹è½½è§†é¢‘ (ç²˜è´´ URL)
Exec=$SCRIPTS/download-yt.sh %f
Icon=download
EOF

  # === Skrypt download-yt.sh ===
  cat > "$SCRIPTS/download-yt.sh" <<'EOF2'
#!/usr/bin/env bash
lang=${LANG:0:2}

# unikalna nazwa pliku docelowego
unique_name() {
  n="$1"; b="${n%.*}"; e="${n##*.}"; o="$n"; i=2
  while [ -e "$o" ]; do o="${b}_$i.$e"; ((i++)); done
  echo "$o"
}

if ! command -v yt-dlp &>/dev/null; then
  case $lang in
    pl) kdialog --error "âŒ Brak yt-dlp" ;;
    de) kdialog --error "âŒ yt-dlp fehlt" ;;
    fr) kdialog --error "âŒ yt-dlp est manquant" ;;
    es) kdialog --error "âŒ Falta yt-dlp" ;;
    it) kdialog --error "âŒ yt-dlp mancante" ;;
    ru) kdialog --error "âŒ yt-dlp Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚" ;;
    zh) kdialog --error "âŒ ç¼ºå°‘ yt-dlp" ;;
  esac
  exit 1
fi

if ! command -v xclip &>/dev/null && ! command -v xsel &>/dev/null; then
  case $lang in
    pl) kdialog --error "âŒ Brak xclip/xsel" ;;
    de) kdialog --error "âŒ xclip/xsel fehlt" ;;
    fr) kdialog --error "âŒ xclip/xsel est manquant" ;;
    es) kdialog --error "âŒ Falta xclip/xsel" ;;
    it) kdialog --error "âŒ xclip/xsel mancante" ;;
    ru) kdialog --error "âŒ xclip/xsel Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚" ;;
    zh) kdialog --error "âŒ ç¼ºå°‘ xclip/xsel" ;;
  esac
  exit 1
fi

target="$1"
if [ -z "$target" ] || [ "$target" = "." ]; then outdir="$(pwd)"
elif [ -d "$target" ]; then outdir="$target"
else outdir="$(dirname "$target")"; fi
cd "$outdir" || exit 1

# pobierz URL
url=$(xclip -o -selection clipboard 2>/dev/null || xsel -ob 2>/dev/null)
[ -z "$url" ] && url=$(kdialog --inputbox "Podaj URL") || true
[ -z "$url" ] && exit 0

# wybÃ³r formatu
choice=$(kdialog --menu "Format:" mp4 "Video MP4" mp3 "Audio MP3") || exit 0

if [ "$choice" = mp3 ]; then
  outfile=$(yt-dlp --get-filename -x --audio-format mp3 -o "%(title)s.%(ext)s" "$url" | head -n1)
  finalfile=$(unique_name "$outfile")
  konsole -e yt-dlp -x --audio-format mp3 -o "$finalfile" "$url"
else
  qual=$(kdialog --menu "RozdzielczoÅ›Ä‡" best "Najlepsza" 480p "480p" 720p "720p" 1080p "1080p" 2160p "2160p") || exit 0
  case "$qual" in
    480p) fmt="bestvideo[height<=480][ext=mp4]+bestaudio[ext=m4a]/mp4";;
    720p) fmt="bestvideo[height<=720][ext=mp4]+bestaudio[ext=m4a]/mp4";;
    1080p) fmt="bestvideo[height<=1080][ext=mp4]+bestaudio[ext=m4a]/mp4";;
    2160p) fmt="bestvideo[height<=2160][ext=mp4]+bestaudio[ext=m4a]/mp4";;
    best) fmt="bestvideo[ext=mp4]+bestaudio[ext=m4a]/mp4";;
  esac
  outfile=$(yt-dlp --get-filename -f "$fmt" -o "%(title)s.%(ext)s" "$url" | head -n1)
  finalfile=$(unique_name "$outfile")
  konsole -e yt-dlp -f "$fmt" -o "$finalfile" "$url"
fi

[ -n "$finalfile" ] && case $lang in
  pl) kdialog --msgbox "âœ… Zapisano: $outdir/$finalfile" ;;
  de) kdialog --msgbox "âœ… Gespeichert: $outdir/$finalfile" ;;
  fr) kdialog --msgbox "âœ… EnregistrÃ©: $outdir/$finalfile" ;;
  es) kdialog --msgbox "âœ… Guardado: $outdir/$finalfile" ;;
  it) kdialog --msgbox "âœ… Salvato: $outdir/$finalfile" ;;
  ru) kdialog --msgbox "âœ… Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¾: $outdir/$finalfile" ;;
  zh) kdialog --msgbox "âœ… å·²ä¿å­˜: $outdir/$finalfile" ;;
esac
EOF2

  chmod +x "$SERVICES/Download-Video.desktop" "$SCRIPTS"/download-yt.sh
  say "âœ… Zainstalowano Downloader" \
      "âœ… Downloader installiert" \
      "âœ… TÃ©lÃ©chargeur installÃ©" \
      "âœ… Descargador instalado" \
      "âœ… Downloader installato" \
      "âœ… Ð—Ð°Ð³Ñ€ÑƒÐ·Ñ‡Ð¸Ðº ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½" \
      "âœ… å·²å®‰è£…ä¸‹è½½å™¨"
}

uninstall_all() {
  rm -f "$SERVICES/Download-Video.desktop" "$SCRIPTS"/download-yt.sh
  say "ðŸ—‘ UsuniÄ™to Downloader" \
      "ðŸ—‘ Downloader entfernt" \
      "ðŸ—‘ TÃ©lÃ©chargeur supprimÃ©" \
      "ðŸ—‘ Descargador eliminado" \
      "ðŸ—‘ Downloader rimosso" \
      "ðŸ—‘ Ð—Ð°Ð³Ñ€ÑƒÐ·Ñ‡Ð¸Ðº ÑƒÐ´Ð°Ð»Ñ‘Ð½" \
      "ðŸ—‘ å·²åˆ é™¤ä¸‹è½½å™¨"
}

# ==== MENU ====
say "ðŸ¬ Image Tools Installer  1 Instaluj, 2 Odinstaluj, 3 WyjÅ›cie" \
    "ðŸ¬ Bild-Tools Installer  1 Installieren, 2 Deinstallieren, 3 Beenden" \
    "ðŸ¬ Installateur Outils Image  1 Installer, 2 Supprimer, 3 Quitter" \
    "ðŸ¬ Instalador Herramientas Imagen  1 Instalar, 2 Desinstalar, 3 Salir" \
    "ðŸ¬ Installer Strumenti Immagine  1 Installa, 2 Rimuovi, 3 Esci" \
    "ðŸ¬ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ñ‰Ð¸Ðº Ð˜Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹  1 Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ, 2 Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ, 3 Ð’Ñ‹Ñ…Ð¾Ð´" \
    "ðŸ¬ å›¾åƒå·¥å…·å®‰è£…ç¨‹åº  1 å®‰è£…, 2 å¸è½½, 3 é€€å‡º"

read -rp "ðŸ‘‰ " choice

case "$choice" in
  1) install_all ;;
  2) uninstall_all ;;
  3) exit 0 ;;
  *) say "âŒ NieprawidÅ‚owy wybÃ³r" \
         "âŒ UngÃ¼ltige Wahl" \
         "âŒ Choix invalide" \
         "âŒ OpciÃ³n invÃ¡lida" \
         "âŒ Scelta non valida" \
         "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð²Ñ‹Ð±Ð¾Ñ€" \
         "âŒ æ— æ•ˆçš„é€‰æ‹©"; exit 1 ;;
esac
EOS
)
