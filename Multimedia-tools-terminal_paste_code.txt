bash <(cat <<'EOS'
#!/usr/bin/env bash
# ==============================================
# Dolphin ServiceMenu: Multimedia Tools (ffmpeg)
# Dependencies: ffmpeg, ffprobe, kdialog
# ==============================================

BASE="$HOME/.local/share"
SERVICES="$BASE/kio/servicemenus"
SCRIPTS="$BASE/dolphin-scripts"

# === BLOK LOKALIZACJI ===
lang=${LANG:0:2}

say() {
  case $lang in
    pl) echo "$1" ;; de) echo "$2" ;; fr) echo "$3" ;; es) echo "$4" ;;
    it) echo "$5" ;; ru) echo "$6" ;; zh) echo "$7" ;; *) echo "$1" ;;
  esac
}

ask_msg() {
  case $lang in
    pl) kdialog --msgbox "$1" ;; de) kdialog --msgbox "$2" ;; fr) kdialog --msgbox "$3" ;;
    es) kdialog --msgbox "$4" ;; it) kdialog --msgbox "$5" ;; ru) kdialog --msgbox "$6" ;;
    zh) kdialog --msgbox "$7" ;; *) kdialog --msgbox "$1" ;;
  esac
}

ask_error() {
  case $lang in
    pl) kdialog --error "$1" ;; de) kdialog --error "$2" ;; fr) kdialog --error "$3" ;;
    es) kdialog --error "$4" ;; it) kdialog --error "$5" ;; ru) kdialog --error "$6" ;;
    zh) kdialog --error "$7" ;; *) kdialog --error "$1" ;;
  esac
}

install_all() {
  mkdir -p "$SERVICES" "$SCRIPTS"

  cat > "$SERVICES/Multimedia-Tools.desktop" <<EOF
[Desktop Entry]
Type=Service
ServiceTypes=KonqPopupMenu/Plugin
MimeType=audio/mpeg;audio/flac;audio/x-wav;video/mp4;video/x-matroska;video/webm;video/x-msvideo;
X-KDE-Submenu=Modify selected file
X-KDE-Submenu[pl]=Modyfikuj zaznaczony plik
X-KDE-Submenu[de]=Datei bearbeiten
X-KDE-Submenu[fr]=Modifier le fichier
X-KDE-Submenu[es]=Modificar archivo
X-KDE-Submenu[it]=Modifica file
X-KDE-Submenu[ru]=Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ»
X-KDE-Submenu[zh_CN]=ä¿®æ”¹æ–‡ä»¶
Actions=Convert;Resize
Icon=folder-video-symbolic

[Desktop Action Convert]
Name=Convert
Name[pl]=Konwertuj
Name[de]=Konvertieren
Name[fr]=Convertir
Name[es]=Convertir
Name[it]=Converti
Name[ru]=ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
Name[zh_CN]=è½¬æ¢
Exec=$SCRIPTS/convert-ffmpeg.sh %F
Icon=media-optical

[Desktop Action Resize]
Name=Resize (MB)
Name[pl]=Zmiana rozmiaru (MB)
Name[de]=GrÃ¶ÃŸe Ã¤ndern (MB)
Name[fr]=Redimensionner (Mo)
Name[es]=Redimensionar (MB)
Name[it]=Ridimensiona (MB)
Name[ru]=Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ (ĞœĞ‘)
Name[zh_CN]=è°ƒæ•´å¤§å° (MB)
Exec=$SCRIPTS/resize-ffmpeg.sh %F
Icon=transform-scale
EOF

  # --- Skrypt konwersji ---
  cat > "$SCRIPTS/convert-ffmpeg.sh" <<'EOF2'
#!/usr/bin/env bash
lang=${LANG:0:2}

if ! command -v ffmpeg &>/dev/null; then
  case $lang in
    pl) kdialog --error "âŒ Brak ffmpeg" ;;
    de) kdialog --error "âŒ ffmpeg fehlt" ;;
    fr) kdialog --error "âŒ ffmpeg est manquant" ;;
    es) kdialog --error "âŒ Falta ffmpeg" ;;
    it) kdialog --error "âŒ ffmpeg mancante" ;;
    ru) kdialog --error "âŒ ffmpeg Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚" ;;
    zh) kdialog --error "âŒ ç¼ºå°‘ ffmpeg" ;;
  esac
  exit 1
fi

cat=$(kdialog --menu "Kategorie" audio "Audio" video "Video") || exit 0
if [ "$cat" = audio ]; then
  fmt=$(kdialog --menu "Audio" mp3 "MP3" wav "WAV" flac "FLAC") || exit 0
else
  fmt=$(kdialog --menu "Video" mp4 "MP4" mov "MOV" webm "WebM" gif "GIF") || exit 0
fi

for f in "$@"; do
  b="${f%.*}"
  case $fmt in
    mp3) ffmpeg -y -i "$f" -q:a 0 -map a "${b}_conv.mp3";;
    wav) ffmpeg -y -i "$f" -acodec pcm_s16le -ar 44100 -ac 2 "${b}_conv.wav";;
    flac) ffmpeg -y -i "$f" -c:a flac "${b}_conv.flac";;
    mp4) ffmpeg -y -i "$f" -c:v libx264 -c:a aac "${b}_conv.mp4";;
    mov) ffmpeg -y -i "$f" -c:v libx264 -c:a aac -movflags +faststart "${b}_conv.mov";;
    webm) ffmpeg -y -i "$f" -c:v libvpx-vp9 -b:v 2M -c:a libopus "${b}_conv.webm";;
    gif) ffmpeg -y -i "$f" -vf "fps=15,scale=640:-1" "${b}_conv.gif";;
  esac
done

case $lang in
  pl) kdialog --msgbox "âœ… Konwersja zakoÅ„czona ($fmt)" ;;
  de) kdialog --msgbox "âœ… Konvertierung abgeschlossen ($fmt)" ;;
  fr) kdialog --msgbox "âœ… Conversion terminÃ©e ($fmt)" ;;
  es) kdialog --msgbox "âœ… ConversiÃ³n completa ($fmt)" ;;
  it) kdialog --msgbox "âœ… Conversione completata ($fmt)" ;;
  ru) kdialog --msgbox "âœ… ĞšĞ¾Ğ½Ğ²ĞµÑ€ÑĞ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ° ($fmt)" ;;
  zh) kdialog --msgbox "âœ… è½¬æ¢å®Œæˆ ($fmt)" ;;
esac
EOF2

  # --- Skrypt resize ---
  cat > "$SCRIPTS/resize-ffmpeg.sh" <<'EOF2'
#!/usr/bin/env bash
lang=${LANG:0:2}

if ! command -v ffmpeg &>/dev/null || ! command -v ffprobe &>/dev/null; then
  case $lang in
    pl) kdialog --error "âŒ Brak ffmpeg/ffprobe" ;;
    de) kdialog --error "âŒ ffmpeg/ffprobe fehlt" ;;
    fr) kdialog --error "âŒ ffmpeg/ffprobe est manquant" ;;
    es) kdialog --error "âŒ Falta ffmpeg/ffprobe" ;;
    it) kdialog --error "âŒ ffmpeg/ffprobe mancante" ;;
    ru) kdialog --error "âŒ ffmpeg/ffprobe Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚" ;;
    zh) kdialog --error "âŒ ç¼ºå°‘ ffmpeg/ffprobe" ;;
  esac
  exit 1
fi

targetMB=$(kdialog --inputbox "Docelowy rozmiar (MB)" "20") || exit 0

for f in "$@"; do
  b="${f%.*}"; ext="${f##*.}"
  dur=$(ffprobe -v error -show_entries format=duration -of csv=p=0 "$f" | cut -d. -f1)
  bitrate=$(( targetMB * 8192 / dur ))
  ffmpeg -y -i "$f" -b:v ${bitrate}k -c:v libx264 -c:a aac -b:a 128k "${b}_resize.${ext}"
done

case $lang in
  pl) kdialog --msgbox "âœ… Zmniejszono do ~${targetMB} MB" ;;
  de) kdialog --msgbox "âœ… Reduziert auf ~${targetMB} MB" ;;
  fr) kdialog --msgbox "âœ… RÃ©duit Ã  ~${targetMB} Mo" ;;
  es) kdialog --msgbox "âœ… Reducido a ~${targetMB} MB" ;;
  it) kdialog --msgbox "âœ… Ridotto a ~${targetMB} MB" ;;
  ru) kdialog --msgbox "âœ… Ğ£Ğ¼ĞµĞ½ÑŒÑˆĞµĞ½Ğ¾ Ğ´Ğ¾ ~${targetMB} MB" ;;
  zh) kdialog --msgbox "âœ… å·²å‡å°åˆ° ~${targetMB} MB" ;;
esac
EOF2

  chmod +x "$SERVICES/Multimedia-Tools.desktop" "$SCRIPTS"/convert-ffmpeg.sh "$SCRIPTS"/resize-ffmpeg.sh
  say "âœ… Zainstalowano narzÄ™dzia Multimedia" \
      "âœ… Multimedia-Tools installiert" \
      "âœ… Outils multimÃ©dia installÃ©s" \
      "âœ… Herramientas multimedia instaladas" \
      "âœ… Strumenti multimediali installati" \
      "âœ… ĞœÑƒĞ»ÑŒÑ‚Ğ¸Ğ¼ĞµĞ´Ğ¸Ğ° Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹" \
      "âœ… å·²å®‰è£…å¤šåª’ä½“å·¥å…·"
}

uninstall_all() {
  rm -f "$SERVICES/Multimedia-Tools.desktop" "$SCRIPTS"/convert-ffmpeg.sh "$SCRIPTS"/resize-ffmpeg.sh
  say "ğŸ—‘ UsuniÄ™to narzÄ™dzia Multimedia" \
      "ğŸ—‘ Multimedia-Tools entfernt" \
      "ğŸ—‘ Outils multimÃ©dia supprimÃ©s" \
      "ğŸ—‘ Herramientas multimedia eliminadas" \
      "ğŸ—‘ Strumenti multimediali rimossi" \
      "ğŸ—‘ ĞœÑƒĞ»ÑŒÑ‚Ğ¸Ğ¼ĞµĞ´Ğ¸Ğ° Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ñ‹" \
      "ğŸ—‘ å·²åˆ é™¤å¤šåª’ä½“å·¥å…·"
}

# ==== MENU ====
say "ğŸ¬ Image Tools Installer  1 Instaluj, 2 Odinstaluj, 3 WyjÅ›cie" \
    "ğŸ¬ Bild-Tools Installer  1 Installieren, 2 Deinstallieren, 3 Beenden" \
    "ğŸ¬ Installateur Outils Image  1 Installer, 2 Supprimer, 3 Quitter" \
    "ğŸ¬ Instalador Herramientas Imagen  1 Instalar, 2 Desinstalar, 3 Salir" \
    "ğŸ¬ Installer Strumenti Immagine  1 Installa, 2 Rimuovi, 3 Esci" \
    "ğŸ¬ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ñ‰Ğ¸Ğº Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ˜Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹  1 Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ, 2 Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ, 3 Ğ’Ñ‹Ñ…Ğ¾Ğ´" \
    "ğŸ¬ å›¾åƒå·¥å…·å®‰è£…ç¨‹åº  1 å®‰è£…, 2 å¸è½½, 3 é€€å‡º"

read -rp "ğŸ‘‰ " choice

case "$choice" in
  1) install_all ;;
  2) uninstall_all ;;
  3) exit 0 ;;
  *) say "âŒ NieprawidÅ‚owy wybÃ³r" "âŒ UngÃ¼ltige Wahl" "âŒ Choix invalide" \
         "âŒ OpciÃ³n invÃ¡lida" "âŒ Scelta non valida" "âŒ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ±Ğ¾Ñ€" \
         "âŒ æ— æ•ˆçš„é€‰æ‹©"; exit 1 ;;
esac
EOS
)
